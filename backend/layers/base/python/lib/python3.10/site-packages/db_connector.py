from typing import Any, Optional

from env_conf import db_host, db_name, db_pass, db_port, db_user
from psycopg2 import pool
from psycopg2.extensions import connection, cursor

pool = pool.ThreadedConnectionPool(
    minconn=1,
    maxconn=10,
    database=db_name,
    user=db_user,
    password=db_pass,
    host=db_host,
    port=db_port
)

def get_connection() -> connection:
    return pool.getconn()


class Cursor:
    def __init__(self) -> None:
        self.conn = get_connection()
        self.conn.autocommit = False

    def __enter__(self) -> cursor:
        return self.conn.cursor()

    def __exit__(
            self,
            exc_type: Optional[Any],
            exc_val: Optional[Any],
            exc_tb: Optional[Any]) -> None:
        if exc_type:
            self.conn.rollback()

        pool.putconn(self.conn)
        return False  # Propagate exceptions

    # def commit(self) -> None:
    #     self.conn.commit()

    # def rollback(self) -> None:
    #     self.conn.rollback()

class CursorCommit:
    def __init__(self) -> None:
        self.conn = get_connection()

    def __enter__(self) -> cursor:
        return self.conn.cursor()

    def __exit__(
            self,
            exc_type: Optional[Any],
            exc_val: Optional[Any],
            exc_tb: Optional[Any]) -> None:
        self.conn.commit()
        pool.putconn(self.conn)


class CursorRollback:
    def __init__(self) -> None:
        self.conn = get_connection()

    def __enter__(self) -> cursor:
        return self.conn.cursor()

    def __exit__(
            self,
            exc_type: Optional[Any],
            exc_val: Optional[Any],
            exc_tb: Optional[Any]) -> None:
        self.conn.rollback()
        pool.putconn(self.conn)
